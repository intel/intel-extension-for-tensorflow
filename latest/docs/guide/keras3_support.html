<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Keras 3 Overview &mdash; Intel® Extension for TensorFlow* 0.1.dev1+g3c076b4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=439db15d" />

  
<script type="text/javascript">
  // Configure TMS settings
  window.wapProfile = 'profile-microsite'; // This is mapped by WAP authorize value
  window.wapLocalCode = 'us-en'; // Dynamically set per localized site, see mapping table for values
  window.wapSection = "intel-extension-for-tensorflow"; // WAP team will give you a unique section for your site
  window.wapEnv = 'prod'; // environment to be use in Adobe Tags.
  // Load TMS
  (() => {
        let url = 'https://www.intel.com/content/dam/www/global/wap/main/wap-microsite.js';
        let po = document.createElement('script'); po.type = 'text/javascript'; po.async = true; po.src = url;
        let s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  }) ();
</script>

    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Intel® Extension for TensorFlow*
          </a>
            <div class="version">
              <a href="../../../versions.html">latest▼</a>
              <p>Click link above to switch version</p>
            </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../get_started.html">Intel® Extension for TensorFlow*</a></li>
<li class="toctree-l1"><a class="reference internal" href="infrastructure.html">Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/installation_guide.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/README.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="practice_guide.html">Practice Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/contributing.html">Contributing guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SECURITY.html">Security Policy</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/intel/intel-extension-for-tensorflow">GitHub Repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Intel® Extension for TensorFlow*</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Keras 3 Overview</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/guide/keras3_support.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="keras-3-overview">
<h1>Keras 3 Overview<a class="headerlink" href="#keras-3-overview" title="Link to this heading"></a></h1>
<p><a class="reference external" href="https://keras.io/about/">Keras</a> is a deep learning API written in Python and capable of running on top of either JAX, TensorFlow, or PyTorch. Both JAX and TensorFlow backend compiles the model by XLA and delivers the best training and prediction performance on GPU. But results vary from model to model, as non XLA TensorFlow is occasionaly faster on GPU. The following image show how ITEX works with XLA, Keras 3 TensorFlow backend and legacy Keras.</p>
<p align="center">
  <img src="images/keras3.png" alt="keras3" />
</p><section id="use-case-with-different-performance">
<h2>Use Case with different performance<a class="headerlink" href="#use-case-with-different-performance" title="Link to this heading"></a></h2>
<p>There are serval use cases that can lead to diffent performance.</p>
<ul class="simple">
<li><p>Default
Users use Keras 3 and the model supports jit, the model will runs into XLA.
If user script does not contains keras related code and does not enables XLA in tensorflow. There will be performance regression. Set environment variable <code class="docutils literal notranslate"><span class="pre">ITEX_DISABLE_XLA=1</span></code> to avoid regression. After ITEX XLA disabled, users can choose wether to use NPD (default) or stream excutor for better performance by environment variable <code class="docutils literal notranslate"><span class="pre">ITEX_ENABLE_NEXTPLUGGABLE_DEVICE</span></code>.</p></li>
<li><p>Legacy Keras
To continue using Keras 2.0, do the following.</p></li>
</ul>
<ol class="simple">
<li><p>Install <code class="docutils literal notranslate"><span class="pre">tf-keras</span></code> via <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">tf-keras</span></code></p></li>
<li><p>To switch <code class="docutils literal notranslate"><span class="pre">tf.keras</span></code> to use Keras 2 (<code class="docutils literal notranslate"><span class="pre">tf-keras</span></code>), set the environment variable <code class="docutils literal notranslate"><span class="pre">TF_USE_LEGACY_KERAS=1</span></code> directly or in your python program with <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">os;os.environ[&quot;TF_USE_LEGACY_KERAS&quot;]=&quot;1&quot;</span></code>. Please note that this will set it for all packages in your Python runtime program</p></li>
<li><p>Change the keras import: replace <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">keras</span></code> with <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">tf_keras</span> <span class="pre">as</span> <span class="pre">keras</span></code>. Update any <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">keras</span> <span class="pre">import</span> </code> to <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">tf_keras</span></code>.</p></li>
</ol>
<p>Users can choose wether to use NPD (default) or stream excutor for better performance by environment variable <code class="docutils literal notranslate"><span class="pre">ITEX_ENABLE_NEXTPLUGGABLE_DEVICE</span></code>.</p>
<ul class="simple">
<li><p>Keras 3 with jit_compile disabled
Users can disable jit_compile by <code class="docutils literal notranslate"><span class="pre">model.jit_compile=False</span></code> or <code class="docutils literal notranslate"><span class="pre">model.compile(...,</span> <span class="pre">jit_compile=False)</span></code>. The use of itex ops override can also lead to disabling jit_compile. In this case, <code class="docutils literal notranslate"><span class="pre">ITEX_DISABLE_XLA=1</span></code> must be set.</p></li>
<li><p>Enable XLA through TensorFlow.
Users can enable XLA through TensorFlow by add environment variable <code class="docutils literal notranslate"><span class="pre">TF_XLA_FLAGS=&quot;--tf_xla_auto_jit=1&quot;</span></code>. Use <code class="docutils literal notranslate"><span class="pre">tf_xla_auto_jit=1</span></code> for auto clustering TF ops into XLA, <code class="docutils literal notranslate"><span class="pre">tf_xla_auto_jit=2</span></code> for compiling all into XLA. Users should set <code class="docutils literal notranslate"><span class="pre">model.jit_compile=False</span></code> if keras model is used. If ITEX custom ops is used or <code class="docutils literal notranslate"><span class="pre">ITEX_OPS_OVERRIDE</span></code> is set, users should use <code class="docutils literal notranslate"><span class="pre">tf_xla_auto_jit=1</span></code> to avoid error.</p></li>
</ul>
</section>
<section id="situations-leads-to-warning-or-error">
<h2>Situations leads to warning or Error<a class="headerlink" href="#situations-leads-to-warning-or-error" title="Link to this heading"></a></h2>
<p>We list all invalid cases here. Keras version equals to 0 means model script does not use Keras.</p>
<p>Note that in any cases, <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">keras</span></code> first before <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">tensorflow</span></code> will cause an error due to circular import in ITEX.</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>OPS_OVERRIDE</th>
<th>TF_AUTO_JIT_FLAG</th>
<th>Keras version</th>
<th>NPD</th>
<th>Jit Compile</th>
<th>Warning</th>
<th>Error</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Any</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>NA</td>
<td></td>
<td>PluggableDevice cannot work with latest Keras.</td>
<td><code>ITEX_DISABLE_XLA=1</code></td>
</tr>
<tr>
<td>Any</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NA</td>
<td>Perf Regression</td>
<td></td>
<td><code>ITEX_DISABLE_XLA=1</code></td>
</tr>
<tr>
<td>Any</td>
<td>Any</td>
<td>2</td>
<td>Any</td>
<td>1</td>
<td></td>
<td></td>
<td>Unkown behavior, not supported. Use <code>TF_AUTO_JIT_FLAG="--tf_xla_auto_jit=1"</code> or <code>2</code> to enable XLA</td>
</tr>
<tr>
<td>Any</td>
<td>0</td>
<td>3</td>
<td>0</td>
<td>Any</td>
<td></td>
<td>Cannot close NPD when keras 3</td>
<td><code>ITEX_DISABLE_XLA=1</code></td>
</tr>
<tr>
<td>Any</td>
<td>0</td>
<td>3</td>
<td>1</td>
<td>0</td>
<td></td>
<td>perf regression</td>
<td><code>ITEX_DISABLE_XLA=1</code></td>
</tr>
<tr>
<td>Any</td>
<td>1</td>
<td>Any</td>
<td>0</td>
<td>Any</td>
<td></td>
<td>Cannot close NPD</td>
<td><code>ITEX_ENABLE_NEXTPLUGGABLE_DEVICE=1</code></td>
</tr>
<tr>
<td>Any</td>
<td>2</td>
<td>Any</td>
<td>0</td>
<td>Any</td>
<td></td>
<td>Cannot close NPD</td>
<td><code>ITEX_ENABLE_NEXTPLUGGABLE_DEVICE=1</code></td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>Any</td>
<td>1</td>
<td>Any</td>
<td>custom op not supported by XLA</td>
<td></td>
<td><code>ITEX_OPS_OVERRIDE=0</code></td>
</tr>
</tbody>
</table></section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2024 Intel Corporation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   <jinja2.runtime.BlockReference object at 0x7f077bf86d70> 
  <p></p><div><a href='https://www.intel.com/content/www/us/en/privacy/intel-cookie-notice.html' data-cookie-notice='true'>Cookies</a> <a href='https://www.intel.com/content/www/us/en/privacy/intel-privacy-notice.html'>| Privacy</a></div>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>